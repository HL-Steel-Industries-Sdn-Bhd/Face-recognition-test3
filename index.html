<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<title>Face Sign In</title>
<script defer src="https://unpkg.com/face-api.js@0.22.2/dist/face-api.min.js"></script>
<style>
body { font-family: Arial; text-align:center; margin-top:20px; }
#video { width: 640px; height: 480px; border-radius:10px; }
#status { margin: 10px 0; font-weight: bold; }
.loading { color: blue; }
.success { color: green; }
.error { color: red; }
canvas { position: absolute; top: 0; left: 0; z-index: 10; }
.video-container { 
    position: relative; 
    display: inline-block; 
    margin-bottom: 20px;
}
#recognitionInfo {
    margin: 20px auto;
    padding: 15px;
    background-color: #f5f5f5;
    border-radius: 8px;
    max-width: 600px;
    text-align: left;
}
.signin-success {
    background-color: #d4edda;
    color: #155724;
    border: 1px solid #c3e6cb;
    padding: 15px;
    margin: 20px auto;
    border-radius: 8px;
    max-width: 600px;
}
#resultIframe {
    display: none;
    width: 0;
    height: 0;
    border: 0;
}
</style>
</head>
<body>

<h2>会议签到（人脸识别）</h2>

<div class="video-container">
    <video id="video" width="640" height="480" autoplay muted></video>
</div>

<div id="status" class="loading">正在初始化...</div>

<div id="recognitionInfo" style="display: none;">
    <h3>识别结果</h3>
    <p>姓名: <span id="recognizedName">-</span></p>
    <p>距离: <span id="recognitionDistance">-</span></p>
    <p>状态: <span id="recognitionStatus">正在识别...</span></p>
</div>

<!-- 添加签到成功提示区域 -->
<div id="signinSuccess" class="signin-success" style="display: none;">
    <h3>✓ 签到成功！</h3>
    <p>姓名: <span id="successName">-</span></p>
    <p>时间: <span id="successTime">-</span></p>
    <p>数据已成功提交到Google表格</p>
</div>

<!-- 隐藏的表单和iframe -->
<iframe id="resultIframe" name="resultIframe"></iframe>
<form id="sendForm" method="post" target="resultIframe" 
      action="https://script.google.com/macros/s/AKfycbwredN437XGaJCdq8qH9dQPM2CkXNNIkPLFfvB8BMxqAvSv7Dd4WnlhIn5wXKY5nsZs/exec 
      style="display: none;">
    <input type="hidden" name="name" id="nameField">
    <input type="hidden" name="timestamp" id="timeField">
</form>

<script>
// ===============================
// 已知用户的 embedding 数据
// ===============================
const KNOWN_DATA = [
{
  "name": "TEST_USER",
  "timestamp": "2025-12-10T06:22:35.483Z",
  "embedding_size": 128,
  "embedding": [
    -0.06074729934334755,
    0.049761030822992325,
    0.07181145250797272,
    0.00615659961476922,
    -0.06382017582654953,
    -0.028527116402983665,
    -0.011132309213280678,
    -0.07834772020578384,
    0.15432244539260864,
    -0.12959709763526917,
    0.1619093120098114,
    -0.05640022084116936,
    -0.19593174755573273,
    -0.04659566283226013,
    -0.010934718884527683,
    0.13739758729934692,
    -0.11358679085969925,
    -0.1546069085597992,
    -0.05871899425983429,
    -0.07648085057735443,
    -0.03218897804617882,
    0.03118472918868065,
    0.02844945527613163,
    0.06790108978748322,
    -0.2229945957660675,
    -0.3526419401168823,
    -0.07911232113838196,
    -0.14296890795230865,
    -0.003926918376237154,
    -0.06916212290525436,
    -0.016959168016910553,
    0.12377352267503738,
    -0.15650683641433716,
    -0.0051583400927484035,
    0.0556291900575161,
    0.1252436488866806,
    -0.02687579020857811,
    -0.027123160660266876,
    0.18749962747097015,
    -0.01978277787566185,
    -0.24098707735538483,
    -0.11743950843811035,
    0.069633349776268,
    0.2787694036960602,
    0.16149194538593292,
    0.02461937628686428,
    0.0031198502983897924,
    -0.0384836383163929,
    0.06637849658727646,
    -0.21637937426567078,
    0.04064042121171951,
    0.09516432881355286,
    0.05855405703186989,
    0.05249037221074104,
    0.06388499587774277,
    -0.11378977447748184,
    0.03885602205991745,
    0.08019985258579254,
    -0.18763116002082825,
    -0.021997760981321335,
    -0.019024992361664772,
    -0.1384740024805069,
    -0.030280064791440964,
    -0.013966763392090797,
    0.29179608821868896,
    0.06467393040657043,
    -0.10829886794090271,
    -0.0647597685456276,
    0.17422285676002502,
    -0.2177613228559494,
    -0.011890554800629616,
    0.09031522274017334,
    -0.0760999321937561,
    -0.1681249588727951,
    -0.31977900862693787,
    -0.02112867310643196,
    0.4507503807544708,
    0.12783287465572357,
    -0.12484368681907654,
    0.1121462881565094,
    -0.033785898238420486,
    -0.058647241443395615,
    0.09331487864255905,
    0.1609264612197876,
    -0.07845430076122284,
    0.07843159139156342,
    -0.03232976794242859,
    0.06537734717130661,
    0.22486311197280884,
    -0.03642253577709198,
    -0.03310360759496689,
    0.12761910259723663,
    -0.06049027293920517,
    0.02507692202925682,
    0.04925740137696266,
    -0.0424870103597641,
    -0.07746921479701996,
    -0.03170831874012947,
    -0.11201406270265579,
    -0.02847052365541458,
    0.04024830460548401,
    -0.013719883747398853,
    -0.0002888003655243665,
    0.10494577884674072,
    -0.21258026361465454,
    0.11749530583620071,
    0.03368375450372696,
    -0.09240713715553284,
    0.04824711009860039,
    0.01559459324926138,
    -0.1055639386177063,
    -0.09501437842845917,
    0.17636454105377197,
    -0.29083001613616943,
    0.11835998296737671,
    0.13868553936481476,
    -0.008517795242369175,
    0.18119536340236664,
    0.06206410005688667,
    0.04073742777109146,
    -0.006727701053023338,
    -0.04300908371806145,
    -0.17227691411972046,
    -0.01808599755167961,
    0.13597024977207184,
    -0.097011998295784,
    0.11615467816591263,
    -0.030860552564263344
  ]
}
];

// 全局变量
let isRecognizing = false;
let modelsLoaded = false;
let hasSignedIn = false;
let isSubmitting = false; // 新增：防止重复提交

// DOM 元素引用
const videoElement = document.getElementById('video');
const statusEl = document.getElementById('status');
const recognitionInfoEl = document.getElementById('recognitionInfo');
const recognizedNameEl = document.getElementById('recognizedName');
const recognitionDistanceEl = document.getElementById('recognitionDistance');
const recognitionStatusEl = document.getElementById('recognitionStatus');
const signinSuccessEl = document.getElementById('signinSuccess');
const successNameEl = document.getElementById('successName');
const successTimeEl = document.getElementById('successTime');

// 页面加载后执行
window.addEventListener('load', async () => {
    try {
        statusEl.textContent = '正在检查 face-api.js...';
        statusEl.className = 'loading';
        
        // 检查 faceapi 是否已加载
        await checkFaceAPI();
        
        // 启动摄像头
        await startCamera();
        
        // 加载模型
        await loadModels();
        
        modelsLoaded = true;
        statusEl.textContent = '✓ 准备就绪！开始人脸识别...';
        statusEl.className = 'success';
        
        // 显示识别信息区域
        recognitionInfoEl.style.display = 'block';
        
        // 开始识别循环
        recognizeLoop();
        
    } catch (error) {
        console.error('初始化失败:', error);
        statusEl.textContent = '初始化失败: ' + error.message;
        statusEl.className = 'error';
    }
});

// 检查 faceapi 是否加载
function checkFaceAPI() {
    return new Promise((resolve, reject) => {
        if (window.faceapi) {
            console.log('faceapi 已加载');
            resolve();
            return;
        }
        
        let attempts = 0;
        const maxAttempts = 30;
        const interval = setInterval(() => {
            attempts++;
            if (window.faceapi) {
                clearInterval(interval);
                console.log('faceapi 加载成功');
                resolve();
            } else if (attempts >= maxAttempts) {
                clearInterval(interval);
                reject(new Error('face-api.js 加载超时'));
            }
        }, 100);
    });
}

// 启动摄像头
async function startCamera() {
    try {
        statusEl.textContent = '正在请求摄像头权限...';
        statusEl.className = 'loading';
        
        const stream = await navigator.mediaDevices.getUserMedia({ 
            video: { 
                width: 640, 
                height: 480,
                facingMode: "user" 
            } 
        });
        
        videoElement.srcObject = stream;
        
        return new Promise((resolve) => {
            videoElement.onloadedmetadata = () => {
                videoElement.play();
                console.log('摄像头启动，视频尺寸:', videoElement.videoWidth, 'x', videoElement.videoHeight);
                resolve();
            };
        });
    } catch (error) {
        console.error('摄像头错误:', error);
        throw new Error('无法访问摄像头: ' + error.message);
    }
}

// 加载模型
async function loadModels() {
    try {
        statusEl.textContent = '正在加载人脸识别模型...';
        statusEl.className = 'loading';
        
        // 使用正确的模型路径
        const MODEL_URL = "https://justadudewhohacks.github.io/face-api.js/models";
        
        console.log('开始加载模型...');
        
        // 加载所需模型
        await faceapi.nets.tinyFaceDetector.loadFromUri(MODEL_URL);
        await faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL);
        await faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL);
        
        console.log('所有模型加载成功');
        
    } catch (error) {
        console.error('模型加载失败:', error);
        throw new Error('模型加载失败: ' + error.message);
    }
}

// 计算欧几里得距离
function euclidDist(a, b) {
    let sum = 0;
    for (let i = 0; i < a.length; i++) {
        const diff = a[i] - b[i];
        sum += diff * diff;
    }
    return Math.sqrt(sum);
}

// 识别循环
async function recognizeLoop() {
    if (!modelsLoaded || isRecognizing || hasSignedIn || isSubmitting) return;
    
    try {
        isRecognizing = true;
        
        // 检测人脸
        const detection = await faceapi
            .detectSingleFace(videoElement, new faceapi.TinyFaceDetectorOptions())
            .withFaceLandmarks()
            .withFaceDescriptor();
        
        if (detection) {
            const liveEmbedding = detection.descriptor;
            let bestName = "UNKNOWN";
            let bestDist = 999;
            
            // 与已知数据比较
            for (const person of KNOWN_DATA) {
                const dist = euclidDist(liveEmbedding, person.embedding);
                if (dist < bestDist) {
                    bestDist = dist;
                    bestName = person.name;
                }
            }
            
            // 更新UI显示
            recognizedNameEl.textContent = bestName;
            recognitionDistanceEl.textContent = bestDist.toFixed(4);
            
            // 阈值判断
            const THRESHOLD = 0.5; // 可以调整这个阈值
            if (bestDist < THRESHOLD) {
                recognitionStatusEl.textContent = '✓ 匹配成功！';
                recognitionStatusEl.style.color = 'green';
                
                // 防止重复签到
                if (!hasSignedIn) {
                    hasSignedIn = true;
                    // 更新状态，显示正在提交
                    statusEl.textContent = `✓ 匹配成功，正在提交数据...`;
                    statusEl.className = 'success';
                    
                    // 显示签到成功区域
                    showSignInSuccess(bestName, bestDist);
                    
                    // 提交数据（隐藏iframe方式，无页面跳转）
                    sendSignIn(bestName, bestDist);
                }
            } else {
                recognitionStatusEl.textContent = '距离过大，未匹配';
                recognitionStatusEl.style.color = 'red';
            }
            
            // 绘制检测框
            drawDetection(detection);
            
        } else {
            recognizedNameEl.textContent = '-';
            recognitionDistanceEl.textContent = '-';
            recognitionStatusEl.textContent = '未检测到人脸';
            recognitionStatusEl.style.color = 'orange';
        }
        
    } catch (error) {
        console.error('识别错误:', error);
        recognitionStatusEl.textContent = '识别错误: ' + error.message;
        recognitionStatusEl.style.color = 'red';
    } finally {
        isRecognizing = false;
        
        // 如果没有签到成功，继续识别
        if (!hasSignedIn && !isSubmitting) {
            setTimeout(recognizeLoop, 500); // 0.5秒后再次识别
        }
    }
}

// 绘制检测结果
function drawDetection(detection) {
    // 移除之前的canvas
    const oldCanvas = document.querySelector('canvas');
    if (oldCanvas) oldCanvas.remove();
    
    // 创建canvas
    const canvas = faceapi.createCanvasFromMedia(videoElement);
    const container = document.querySelector('.video-container');
    container.appendChild(canvas);
    
    // 匹配尺寸
    const displaySize = { width: videoElement.width, height: videoElement.height };
    faceapi.matchDimensions(canvas, displaySize);
    
    // 调整检测结果尺寸
    const resizedDetection = faceapi.resizeResults(detection, displaySize);
    
    // 绘制
    faceapi.draw.drawDetections(canvas, [resizedDetection]);
    faceapi.draw.drawFaceLandmarks(canvas, [resizedDetection]);
}

// 显示签到成功信息
function showSignInSuccess(name, distance) {
    const now = new Date();
    successNameEl.textContent = name;
    successTimeEl.textContent = now.toLocaleString();
    
    // 隐藏识别信息区域
    recognitionInfoEl.style.display = 'none';
    
    // 显示签到成功区域
    signinSuccessEl.style.display = 'block';
    
    // 停止摄像头
    if (videoElement.srcObject) {
        const tracks = videoElement.srcObject.getTracks();
        tracks.forEach(track => track.stop());
        videoElement.style.opacity = '0.3'; // 让视频变暗
    }
}

// 发送签到信息（使用隐藏iframe，无页面跳转）
function sendSignIn(name, distance) {
    try {
        isSubmitting = true;
        
        // 设置表单数据
        document.getElementById("nameField").value = name;
        document.getElementById("timeField").value = new Date().toISOString();
        
        console.log('正在提交数据到Google表格:', name);
        
        // 添加iframe加载完成的事件监听
        const iframe = document.getElementById('resultIframe');
        iframe.onload = function() {
            console.log('数据提交完成！');
            isSubmitting = false;
            
            // 更新最终状态
            statusEl.textContent = `✓ 签到完成！数据已保存到Google表格`;
            statusEl.className = 'success';
            
            // 显示成功消息（可选）
            setTimeout(() => {
                alert(`签到成功！\n姓名: ${name}\n距离: ${distance.toFixed(4)}\n数据已保存到Google表格`);
            }, 500);
        };
        
        // 提交表单（将提交到隐藏iframe中）
        document.getElementById("sendForm").submit();
        
    } catch (error) {
        console.error('提交失败:', error);
        statusEl.textContent = '提交失败: ' + error.message;
        statusEl.className = 'error';
        alert('签到提交失败，请手动记录。错误: ' + error.message);
        isSubmitting = false;
        hasSignedIn = false; // 允许重试
    }
}

// 添加页面卸载时的清理
window.addEventListener('beforeunload', () => {
    if (videoElement.srcObject) {
        const tracks = videoElement.srcObject.getTracks();
        tracks.forEach(track => track.stop());
    }
});

// 全局错误处理
window.addEventListener('error', (e) => {
    console.error('全局错误:', e.error);
    if (statusEl) {
        statusEl.textContent = '发生错误: ' + e.message;
        statusEl.className = 'error';
    }
});
</script>

</body>
</html>
